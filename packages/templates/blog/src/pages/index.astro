---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import PostCard from '../components/PostCard.astro';
import { getServer, getThreads, getExcerpt, getReadingTime } from '../lib/discordlink';

const server = await getServer();
const threads = await getThreads();

// Get first message content for excerpts
const postsWithExcerpts = threads.map((thread) => ({
  ...thread,
  excerpt: getExcerpt(thread.title, 150),
  readingTime: getReadingTime(thread.title),
}));

const featuredPost = postsWithExcerpts[0];
const recentPosts = postsWithExcerpts.slice(1, 7);
---

<BaseLayout
  title={`${server.name} Blog`}
  description={server.description || `Latest posts from ${server.name}`}
  canonical={Astro.url.href}
>
  <Header siteName={`${server.name} Blog`} />

  <main class="container">
    {featuredPost && (
      <section class="featured">
        <span class="label">Featured</span>
        <h1><a href={`/posts/${featuredPost.slug}`}>{featuredPost.title}</a></h1>
        <p class="excerpt">{featuredPost.excerpt}</p>
        <div class="meta">
          {featuredPost.author && <span>By {featuredPost.author.username}</span>}
          <span>{new Date(featuredPost.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
          <span>{featuredPost.readingTime} min read</span>
        </div>
      </section>
    )}

    <section class="posts">
      <h2>Recent Posts</h2>
      <div class="posts-grid">
        {recentPosts.map((post) => (
          <PostCard
            title={post.title}
            slug={post.slug}
            excerpt={post.excerpt}
            date={post.createdAt}
            readingTime={post.readingTime}
            author={post.author || undefined}
          />
        ))}
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <p>Powered by <a href="https://discordlink.dev">DiscordLink</a></p>
  </footer>
</BaseLayout>

<style>
  .container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem;
  }
  .featured {
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2.5rem;
    margin-bottom: 3rem;
    text-align: center;
  }
  .featured .label {
    display: inline-block;
    background: var(--accent);
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    margin-bottom: 1rem;
  }
  .featured h1 {
    font-size: 2rem;
    margin-bottom: 1rem;
    line-height: 1.3;
  }
  .featured h1 a {
    color: var(--text-primary);
  }
  .featured h1 a:hover {
    color: var(--accent);
    text-decoration: none;
  }
  .featured .excerpt {
    color: var(--text-secondary);
    font-size: 1.1rem;
    max-width: 600px;
    margin: 0 auto 1rem;
  }
  .featured .meta {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }
  .posts h2 {
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }
  .site-footer {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
    border-top: 1px solid var(--border);
    margin-top: 3rem;
  }
</style>
